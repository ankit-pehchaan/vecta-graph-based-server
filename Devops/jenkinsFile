pipeline {
    agent any
    environment {
        AWS_DEFAULT_REGION = 'ap-southeast-2'
        AWS_REGION = 'ap-southeast-2'
        ECR_REPO = 'vecta/vectabe'
        IMAGE_NAME = 'vectabe'
        ECR_REGISTRY = '966936070995.dkr.ecr.ap-southeast-2.amazonaws.com'
        DOCKER_IMAGE = "${ECR_REGISTRY}/${ECR_REPO}:latest"
        CLUSTER_NAME = 'vecta_be_cluster_dev'
        SERVICE_NAME = 'vecta-be-task-service'
        TASK_DEF = 'vecta-be-task'
    }
    options {
        skipStagesAfterUnstable()
        buildDiscarder(logRotator(numToKeepStr: '5'))
        timestamps()
    }

    stages {
        stage('Clean Old Docker Images') {
            steps {
                script {
                    sh '''
                        docker system prune -af || true
                    '''
                }
            }
        }

        stage('Git Pull') {
            steps {
                git url: 'git@github.com:Pehchaan-Tech/Vecta-Server.git',
                        branch: 'main',
                        credentialsId: 'git'
            }
        }

        stage('Docker Build') {
            steps {
                script {
                    sh """
                        docker build -t ${DOCKER_IMAGE} .
                    """
                }
            }
        }

        stage('Push to Amazon ECR') {
            steps {
                script {
                    withCredentials([[
                        $class: 'AmazonWebServicesCredentialsBinding',
                        credentialsId: 'aws'
                    ]]) {
                        sh '''
                            aws sts get-caller-identity
                            aws ecr get-login-password --region $AWS_REGION \
                                | docker login --username AWS --password-stdin $ECR_REGISTRY

                            docker push $DOCKER_IMAGE
                        '''
                    }
                }
            }
        }

        stage('Trigger ECS Deployment') {
            steps {
                script {
                    withCredentials([[
                        $class: 'AmazonWebServicesCredentialsBinding',
                        credentialsId: 'aws'
                    ]]) {
                        sh '''
                            set -e

                            echo "Getting current task definition..."
                            TASK_DEF=$(aws ecs describe-services \
                                --cluster "$CLUSTER_NAME" \
                                --services "$SERVICE_NAME" \
                                --query "services[0].taskDefinition" \
                                --output text)

                            echo "Current task definition: $TASK_DEF"

                            echo "Triggering force deployment..."
                            aws ecs update-service \
                                --cluster "$CLUSTER_NAME" \
                                --service "$SERVICE_NAME" \
                                --task-definition "$TASK_DEF" \
                                --force-new-deployment

                            aws ecs wait services-stable \
                                --cluster "$CLUSTER_NAME" \
                                --services "$SERVICE_NAME" \
                                --region us-west-1

                            echo "ECS redeployment triggered successfully."
                        '''
                    }
                }
            }
        }

        stage('Send Notification Email') {
            steps {
                script {
                    emailext(
                        subject: "✅ ECS Deployment Successful - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                        body: """\
                            <p>Hello Team,</p>
                            <p>The AWS deployment has completed successfully for:</p>
                            <ul>
                                <li><strong>Job:</strong> Vecta Backend</li>
                                <li><strong>Job:</strong> ${env.JOB_NAME}</li>
                                <li><strong>Build Number:</strong> ${env.BUILD_NUMBER}</li>
                                <li><strong>Build URL:</strong> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></li>
                            </ul>
                            <p>Regards,<br/>Jenkins</p>
                        """,
                        mimeType: 'text/html',
                        from: 'support@vectatech.com.au',
                        to: 'rakesh.sai@pehchaan.me'
                    )
                }
            }
        }
    }

    post {
        failure {
            emailext(
                subject: "❌ ECS Deployment Failed - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """
                    <p>The ECS deployment has failed.</p>
                    <p><a href="${env.BUILD_URL}">View Build</a></p>
                """,
                mimeType: 'text/html',
                from: 'support@vectatech.com.au',
                to: 'rakesh.sai@pehchaan.me'
            )
        }
    }
}
